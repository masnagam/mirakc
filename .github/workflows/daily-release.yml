# DO NOT EDIT THIS FILE BY HAND.
#
# This file was generated by scripts/make-github-workflows automagically.
name: Daily (release)
on:
  schedule:
    - cron: '16 16 * * *' # UTC
env:
  MIRAKC_GA_REF_NAME: release
  MIRAKC_GA_REF_TYPE: branch
  # Use PAT in order to invoke other workflows.
  MIRAKC_GA_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      num-commits: ${{ steps.count.outputs.num-commits }}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ env.MIRAKC_GA_REF_NAME }}
          token: ${{ env.MIRAKC_GA_TOKEN }}
      - name: git config
        run: |
          # https://github.com/actions/checkout#push-a-commit-using-the-built-in-token
          git config user.name github-actions
          git config user.email github-actions@github.com
      - name: Login to Docker Hub # for avoiding the download rate limit
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Update .devcontainer/Dockerfile
        run: |
          ./scripts/update-devcontainer-dockerfile
      - name: Update resources/mirakurun.openapi.json
        run: |
          timeout 120 ./scripts/update-mirakurun-openapi-json
      - name: Update mirakc-arib
        if: env.MIRAKC_GA_REF_NAME == 'main'
        run: |
          ./scripts/update-mirakc-arib
      - name: Push if changed
        run: |
          if git diff --quiet origin/$MIRAKC_GA_REF_NAME..HEAD
          then
            echo "No commit to push"
          else
            git push
          fi
      - name: Count commits made within 24 hours
        id: count
        run: |
          NUM_COMMITS=$(git rev-list --count --since '24 hours' $MIRAKC_GA_REF_NAME)
          echo "NUM_COMMITS=$NUM_COMMITS"
          echo "::set-output name=num-commits::$NUM_COMMITS"
